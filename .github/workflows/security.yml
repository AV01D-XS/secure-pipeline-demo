name: Ghost Security Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  # JOB 1: SECRET SCANNING
  # This finds the fake AWS keys in app.py
  secret-scan:
    name: üïµÔ∏è Secret Scanner (TruffleHog)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Essential for scanning git history

    # REPLACEMENT STEP
      - name: TruffleHog OSS
        # We run the docker container directly to scan the current folder (.)
        # This is bulletproof for demos.
        run: docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest filesystem /pwd --fail
        continue-on-error: true

  # JOB 2: STATIC ANALYSIS (SAST)
  # This finds the SQL Injection in app.py
  code-scan:
    name: üõ°Ô∏è Code Vulnerability Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit Scan
        # Scans current directory (.) recursively (-r)
        # -ll means report Medium and High severity issues
        run: bandit -r . -ll
        continue-on-error: true
